# CLAUDE.md — Engineering Contract

**Project:** Yield — Algorithm Visualizer
**Stack:** Next.js 16 (Stable), React 19, Tailwind CSS v4, Biome, Vitest
**Architecture:** Feature-Sliced Design (FSD) variant

---

## 1. Non-Negotiable Rules

### 1.1 TypeScript Strictness

- `strict: true` is immutable.
- `any` is strictly banned. Use `unknown` and narrow types via Zod schemas or type guards.
- All Generator functions (`function*`) must have explicit `Yield`, `Return`, and `Next` types.
- Props interfaces: Exported as `{ComponentName}Props`.
- `as` assertions require inline comment justification explaining why the type system cannot infer correctness.

### 1.2 Code Hygiene (Biome Standard)

- **Linter:** Biome is the authority. No ESLint/Prettier configuration overrides.
- **Console:** `console.log` is banned in committed code. Use a dedicated Logger utility for dev-only traces.
- **Dead Code:** No commented-out blocks. Git history is the backup.
- **Magic Numbers:** Banned. Use `const` configurations or Tailwind classes.
- **Imports:** Sorted by depth via Biome. Absolute imports (`@/features/...`) mandatory for internal code.

### 1.3 Performance & Rendering (Crucial for Visualizer)

- **Layout Thrashing:** Strictly forbidden. Do not read DOM properties (scrollTop, offsetHeight) in the same frame as writing them.
- **Framer Motion:** Use `transform` properties (`x`, `y`, `scale`) over layout properties (`width`, `left`) wherever possible to enable GPU acceleration.
- **Memoization:** `useMemo` and `useCallback` are mandatory for all props passed to visualizer components (Bars, Nodes) to prevent unnecessary re-renders during high-frequency animation frames.
- **Heap Allocation:** Minimize object creation inside render loops (e.g., inside the sorting loop).

### 1.4 Accessibility (WCAG AA)

- Keyboard navigation is mandatory for all controls (Play, Pause, Step).
- Focus indicators must be visible and distinct.
- Color alone cannot convey meaning (e.g., sorting comparisons need distinct visual states/shapes, not just color changes).
- Reduced Motion: Respect `prefers-reduced-motion` by disabling auto-play or smoothing transitions.

### 1.5 Living Documentation

- This file (`CLAUDE.md`) is the **Single Source of Truth**.
- If architectural decisions change, this document must be updated _before_ code is written.
- If you (the LLM) encounter a discrepancy between this doc and the codebase, prioritize this doc and refactor the code.

### 1.6 AI Attribution (Strictly Forbidden)

- Zero tolerance for AI disclosure in source code or version control.
- Commit messages and PR descriptions must be written in the voice of the Lead Engineer.
- Never add comments like "Generated by..." or "AI suggested...".

---

## 2. Git Workflow

### 2.1 Branch Strategy

- **Main:** Protected. Production-ready code only.
- **Feature Branches:** `feature/category-name` (e.g., `feature/bubble-sort`, `feature/ui-controls`).
- **Fix Branches:** `fix/issue-description`.

### 2.2 Atomic Commits

- Format: Conventional Commits (`<type>(<scope>): <subject>`).
- Types: `feat`, `fix`, `perf`, `refactor`, `test`, `chore`.
- Scopes: `engine`, `visualizer`, `ui`, `core`, `config`.
- Example: `feat(engine): implement generator yield for swap operations`

---

## 3. Architecture & Directory Structure

We adhere to a strict Feature-Based Architecture to prevent spaghetti code.

```text
src/
├── app/                  # Routing layer (Pages, Layouts only)
├── features/             # Business Domains
│   ├── algorithms/       # The "Engine"
│   │   ├── sorting/      # Sorting implementations (Generators)
│   │   ├── pathfinding/  # Pathfinding implementations
│   │   └── hooks/        # useAlgorithm() hook
│   ├── visualizer/       # The "View"
│   │   ├── components/   # Bars, Grid, Nodes
│   │   └── logic/        # Animation orchestration
│   └── controls/         # Playback UI (Slider, Play/Pause)
├── lib/                  # Shared core utilities (Math, Types)
├── ui/                   # Dumb/Generic UI Components (Button, Slider) - Radix/Tailwind
└── styles/               # Global CSS variables
```

**Rule:** `features` can import from `ui` and `lib`, but strictly avoid circular dependencies between sibling features.

---

## 4. Component Standards

### 4.1 React Components

```tsx
import { memo } from "react";
import { cn } from "@/lib/utils";

export interface SortingBarProps {
  value: number;
  isActive: boolean;
  height: number;
}

export const SortingBar = memo(function SortingBar({
  value,
  isActive,
  height,
}: SortingBarProps) {
  return (
    <div
      className={cn(
        "w-4 transition-colors duration-300 ease-out", // Tailwind v4
        isActive ? "bg-primary" : "bg-muted"
      )}
      style={{ height: `${height}%` }}
      role="img"
      aria-label={`Value: ${value}`}
    />
  );
});
```

### 4.2 Generator Functions (The Engine)

All algorithms must be implemented as Generators to support "Step-by-Step" execution.

```typescript
export type YieldStep = {
  type: "compare" | "swap" | "overwrite";
  indices: number[];
  values?: number[];
};

export function* bubbleSort(
  arr: number[]
): Generator<YieldStep, void, unknown> {
  // Implementation
}
```

---

## 5. Styling Standards

- **Engine:** Tailwind CSS v4.
- **Variables:** Use CSS variables for all design tokens (colors, spacing) to support instant theming.
- **Prefixes:** Use semantic prefixes: `bg-background`, `text-foreground`, `border-border`.
- **Dark Mode:** Native support required.

---

## 6. Testing Strategy

**Tooling:** Vitest + React Testing Library.

### 6.1 Unit Tests (Engine)

- Every algorithm must have a corresponding test file ensuring it sorts/solves correctly.
- Test edge cases: Empty arrays, single-element arrays, reverse-sorted arrays.

### 6.2 Component Tests (Visualizer)

- Verify `aria-labels` update during state changes.
- Smoke tests for rendering.

```typescript
// Example: src/features/algorithms/sorting/bubbleSort.test.ts
import { describe, it, expect } from "vitest";
import { bubbleSort } from "./bubbleSort";

describe("bubbleSort", () => {
  it("correctly sorts a reverse array", () => {
    // Test logic
  });
});
```

---

## 7. Deployment & CI

- **Biome Check:** Must pass before push.
- **Type Check:** Zero errors allowed.
- **Build:** `next build` must succeed locally.
- **Vercel:** Automatic deployments on merge to main.

---

## 8. Security

### 8.1 Security Headers

All routes serve the following security headers (configured in `next.config.ts`):

- **Content-Security-Policy (CSP):** Restricts script/style/image sources to trusted origins.
  - `script-src`: self, GTM, Google Analytics (requires `unsafe-inline` for GTM consent script)
  - `style-src`: self, Google Fonts (requires `unsafe-inline` for KaTeX)
  - `img-src`: self, data URIs, HTTPS sources
  - `frame-ancestors`: self only (prevents clickjacking)
- **Strict-Transport-Security (HSTS):** 1 year, includes subdomains, preload-ready.
- **X-Content-Type-Options:** nosniff (prevents MIME type sniffing).
- **X-Frame-Options:** SAMEORIGIN (backup for CSP frame-ancestors).
- **Referrer-Policy:** strict-origin-when-cross-origin.
- **Permissions-Policy:** Restricts access to sensitive browser APIs (camera, microphone, etc.).

**Note:** The `poweredByHeader` is disabled to reduce fingerprinting.

### 8.2 Environment Variables

- All environment variables are validated at startup via `src/lib/env.ts`.
- Only `NEXT_PUBLIC_` prefixed variables are used (client-safe by design).
- No secrets or API keys are stored in the codebase or environment.
- Missing required variables in production cause clear startup failures.
- Validation includes format checking for GTM ID and GA Measurement ID.

### 8.3 Input Validation

- URL parameters are validated via whitelist patterns (see `UrlStateSync.tsx`).
- Only pre-approved algorithm/mode values are accepted.
- Invalid input is silently ignored or returns 404.
- No user input is directly rendered without validation.

### 8.4 dangerouslySetInnerHTML Usage

All instances are justified and reviewed:

1. **JSON-LD scripts** (learning pages): Server-generated from static content, produces inert JSON.
2. **KaTeX math rendering**: Trusted library with sanitized output.
3. **GTM consent script**: Static, hardcoded Google snippet.
4. **GTM loader script**: Static snippet with only GTM ID interpolation.

All content originates from static TypeScript files, never from user input.

### 8.5 Analytics & Privacy

- Analytics is consent-gated (GDPR/CCPA compliant).
- Region-aware defaults: EEA/UK/Switzerland deny by default.
- No tracking occurs until explicit user consent.
- Consent state is stored in localStorage (non-sensitive).
- No PII is collected or transmitted.

### 8.6 Production Deployment Checklist

Before deploying to production:

1. **HTTPS Required:** The application expects HTTPS in production. HSTS is enabled.
2. **Reverse Proxy:** If behind a proxy (Vercel, Cloudflare), ensure headers are preserved.
3. **Environment Variables:** Verify `NEXT_PUBLIC_BASE_URL` is set to the production domain.
4. **CSP Monitoring:** Consider adding `report-uri` or `report-to` directive for CSP violation reports.

### 8.7 Residual Risks & Future Improvements

**Accepted Tradeoffs:**
- CSP requires `unsafe-inline` for scripts (GTM requirement) and styles (KaTeX).
- A nonce-based CSP would be more secure but requires GTM refactoring.

**Future Improvements:**
- Implement CSP nonce generation for inline scripts.
- Add rate limiting if API routes are introduced.
- Add Content-Security-Policy-Report-Only for monitoring before enforcement.
- Consider Subresource Integrity (SRI) for external scripts.

---

**END OF CONTRACT**
This document governs all engineering decisions for Yield.
